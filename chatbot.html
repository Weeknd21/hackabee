<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chatbot UGTO con Gemini</title>
    <style>
        /* --- Estilos (sin cambios) --- */
        body { font-family: sans-serif; background-color: #fdfaf6; color: #333; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        #chat-container { width: 90%; max-width: 500px; height: 70vh; background-color: #fff; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; flex-direction: column; overflow: hidden; }
        #chat-header { background-color: #EABE7C; color: #000; padding: 1.2rem; text-align: center; font-size: 1.5rem; font-weight: bold; border-bottom: 2px solid #D4A373; }
        #chat-messages { flex-grow: 1; padding: 1.5rem; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; }
        .message { padding: 0.8rem 1.2rem; border-radius: 20px; line-height: 1.5; max-width: 80%; }
        .user-message { background-color: #f0f0f0; color: #333; align-self: flex-end; border-bottom-right-radius: 5px; }
        .bot-message { background-color: #EABE7C; color: #000; align-self: flex-start; border-bottom-left-radius: 5px; }
        .error-message { background-color: #d9534f; color: white; align-self: flex-start; }
        #chat-input { display: flex; border-top: 2px solid #f0f0f0; padding: 1rem; }
        #chat-input input { flex-grow: 1; border: none; padding: 0.8rem; font-size: 1rem; border-radius: 20px; background-color: #f0f0f0; outline: none; transition: background-color 0.3s; }
        #chat-input input:focus { background-color: #e9e9e9; }
        #chat-input button { background-color: #000; color: #fff; border: none; padding: 0.8rem 1.5rem; margin-left: 0.5rem; border-radius: 20px; cursor: pointer; font-size: 1rem; transition: background-color 0.3s; }
        #chat-input button:hover { background-color: #333; }
    </style>
</head>
<body>
    <div id="chat-container">
        <div id="chat-header">Asistente UGTO (con IA)</div>
        <div id="chat-messages">
             <div class="message bot-message">¡Hola! Soy tu asistente virtual de la UGTO mejorado con IA. ¿En qué puedo ayudarte hoy?</div>
        </div>
        <div id="chat-input">
            <input type="text" id="user-input" placeholder="Escribe tu pregunta...">
            <button id="send-button">Enviar</button>
        </div>
    </div>

    <script type="module">
        // --- Importaciones y configuración de la API ---
        // **CORREGIDO**: Se usa esm.run para asegurar que se carga la versión para navegador (ES Module).
        const { GoogleGenerativeAI } = await import("https://esm.run/@google/generative-ai");

        // =========================================================================================
        // TU API KEY VA AQUÍ
        // Recuerda que ya pusiste tu clave, ¡no la cambies!
        const API_KEY = "AIzaSyANG6cABgPV7N0QK0ElY6jZcNZ5cWMt1dI"; 
        // =========================================================================================

        const messagesContainer = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendButton = document.getElementById('send-button');
        
        let database = null;
        let genAI;
        let generativeModel;

        // --- Inicialización y carga de datos ---
        async function initializeAI() {
            if (!API_KEY || API_KEY === "PEGA_TU_API_KEY_AQUI") {
                addMessage("Error de configuración: La clave de API de Gemini no ha sido configurada. Por favor, edita este archivo y añade tu clave.", "error");
                return false;
            }
            try {
                genAI = new GoogleGenerativeAI(API_KEY);
                generativeModel = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                return true;
            } catch (error) {
                console.error("Error al inicializar Gemini:", error);
                addMessage(`Error al conectar con la API de Gemini. Revisa la consola (F12) para más detalles.`, "error");
                return false;
            }
        }

        async function loadDatabase() {
            try {
                const response = await fetch('./base_datos_ugto_completa.json');
                if (!response.ok) throw new Error(`Error al cargar el archivo JSON: ${response.status}`);
                database = await response.json();
                addMessage('Base de conocimiento cargada. ¡Listo para ayudar!', 'bot');
            } catch (e) {
                console.error('Error fatal:', e);
                addMessage('Error: No pude cargar mi base de conocimiento (el archivo JSON). Asegúrate de que está en la misma carpeta que este archivo HTML.', 'error');
                database = null;
            }
        }

        // --- Lógica del Chat ---
        function addMessage(text, type) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', `${type}-message`);
            messageDiv.textContent = text;
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function getBotResponse(userMessage) {
            if (!database) return addMessage("Lo siento, mi base de conocimiento no está disponible.", "error");
            if (!generativeModel) return addMessage("Lo siento, el modelo de IA no se ha inicializado correctamente.", "error");

            const thinkingMessage = document.createElement('div');
            thinkingMessage.classList.add('message', 'bot-message');
            thinkingMessage.textContent = "Pensando...";
            messagesContainer.appendChild(thinkingMessage);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            const context = JSON.stringify(database);
            const prompt = `
                Eres "Asistente UGTO", un chatbot experto y amigable de la Universidad de Guanajuato.
                Tu ÚNICA fuente de información es el siguiente documento JSON. NO debes usar conocimiento externo.
                Basándote EXCLUSIVAMENTE en este contexto, responde la pregunta del usuario de manera clara y concisa.
                Si la respuesta no se encuentra en el contexto, debes decir "Lo siento, no tengo información sobre ese tema en mi base de conocimiento.".

                CONTEXTO JSON:
                ${context}

                PREGUNTA DEL USUARIO:
                "${userMessage}"
            `;

            try {
                const result = await generativeModel.generateContent(prompt);
                const response = result.response;
                const text = await response.text();
                thinkingMessage.textContent = text;
            } catch (error) {
                console.error("Error al generar contenido:", error);
                thinkingMessage.textContent = "Hubo un error al procesar tu pregunta. Por favor, intenta de nuevo.";
                thinkingMessage.classList.add('error-message');
            }
        }

        async function handleSend() {
            const message = userInput.value.trim();
            if (!message) return;
            addMessage(message, 'user');
            userInput.value = '';
            await getBotResponse(message);
        }

        // --- Ejecución inicial ---
        sendButton.addEventListener('click', handleSend);
        userInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault();
                handleSend();
            }
        });

        async function main() {
            const aiReady = await initializeAI();
            if (aiReady) {
                await loadDatabase();
            }
        }
        
        main();
    </script>
</body>
</html>
